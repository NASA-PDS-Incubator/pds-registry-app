<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from src/site/xdoc/operate/common-ops.xml.vm at 2021-12-10
 | Rendered using Apache Maven Fluido Skin 1.8
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>Registry Application &#x2013; Common Operations</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.8.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.8.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><a href="https://pds.nasa.gov" id="bannerLeft"><img src="../images/pds_banner.png"  alt="" width="500"/></a></div>
          <div class="pull-right"><a href="https://github.com/NASA-PDS/pds-registry-app" id="bannerRight"><h2>PDS Registry</h2>
</a></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2021-12-10<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.0.1</li>
      <li class="pull-right"><a href="https://github.com/NASA-PDS/pds-registry-app" class="externalLink" title="Registry App Github Repo">Registry App Github Repo</a></li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Software Documentation</li>
    <li><a href="../index.html" title="About PDS Registry Application"><span class="none"></span>About PDS Registry Application</a></li>
    <li><a href="../install/index.html" title="Installation"><span class="icon-chevron-down"></span>Installation</a>
     <ul class="nav nav-list">
      <li><a href="../install/java.html" title="Java"><span class="none"></span>Java</a></li>
      <li><a href="../install/es-dev.html" title="Elasticsearch - Quick Start"><span class="none"></span>Elasticsearch - Quick Start</a></li>
      <li><a href="../install/tools.html" title="Tools (Manager, Harvest)"><span class="none"></span>Tools (Manager, Harvest)</a></li>
      <li><a href="../install/api-server.html" title="API Server"><span class="none"></span>API Server</a></li>
      <li><a href="../install/test.html" title="Test your deployment"><span class="none"></span>Test your deployment</a></li>
     </ul></li>
    <li><a href="../operate/index.html" title="Operation"><span class="icon-chevron-down"></span>Operation</a>
     <ul class="nav nav-list">
      <li class="active"><a href="#"><span class="none"></span>Common Operations</a></li>
      <li><a href="../operate/test-vs-prod.html" title="Test vs Prod"><span class="none"></span>Test vs Prod</a></li>
      <li><a href="../operate/harvest.html" title="Harvest"><span class="none"></span>Harvest</a></li>
      <li><a href="../operate/reg-manager.html" title="Registry Manager"><span class="none"></span>Registry Manager</a></li>
      <li><a href="../operate/supplementer.html" title="Supplementer"><span class="none"></span>Supplementer</a></li>
      <li><a href="../operate/reg-custom.html" title="Registry Customization"><span class="none"></span>Registry Customization</a></li>
     </ul></li>
    <li><a href="../prod/index.html" title="Production Deployment"><span class="icon-chevron-down"></span>Production Deployment</a>
     <ul class="nav nav-list">
      <li><a href="../prod/es-vm.html" title="Elasticsearch (VM)"><span class="none"></span>Elasticsearch (VM)</a></li>
     </ul></li>
    <li><a href="../security/index.html" title="Security"><span class="icon-chevron-down"></span>Security</a>
     <ul class="nav nav-list">
      <li><a href="../security/proxy.html" title="Load Balancer & Proxy"><span class="none"></span>Load Balancer & Proxy</a></li>
      <li><a href="../security/es.html" title="Elasticsearch"><span class="none"></span>Elasticsearch</a></li>
      <li><a href="../security/reg-mgr.html" title="Registry Manager"><span class="none"></span>Registry Manager</a></li>
     </ul></li>
    <li><a href="../index.html#Support" title="Support"><span class="none"></span>Support</a></li>
   <li class="nav-header">Downloads</li>
    <li><a href="https://github.com/NASA-PDS/pds-registry-app/releases/download/v1.0.1/pds-registry-app-1.0.1-bin.tar.gz" class="externalLink" title="Current Release (tar.gz)"><span class="none"></span>Current Release (tar.gz)</a></li>
    <li><a href="https://github.com/NASA-PDS/pds-registry-app/releases/download/v1.0.1/pds-registry-app-1.0.1-bin.zip" class="externalLink" title="Current Release (zip)"><span class="none"></span>Current Release (zip)</a></li>
    <li><a href="https://pds-engineering.jpl.nasa.gov/content/pds4-software" class="externalLink" title="Past Releases"><span class="none"></span>Past Releases</a></li>
   <li class="nav-header">Change Log</li>
    <li><a href="https://github.com/NASA-PDS/pds-registry-app/blob/main/CHANGELOG.md" class="externalLink" title="On Github"><span class="none"></span>On Github</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <hr />
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >



<section>
<h2><a name="Common_Operations"></a>Common Operations</h2>


<p>
</p>
<ul>
  
<li><a href="#Harvest">Extract Metadata (Harvest)</a></li>
  
<li><a href="#CRUD">Create, Delete, Customize Registry</a></li>
  
<li><a href="#Load">Load Metadata</a></li>
  
<li><a href="#View">View, Search Metadata</a></li>
  
<li><a href="#Delete">Delete Metadata</a></li>
  
<li><a href="#Export">Export Metadata</a></li>
  
<li><a href="#ExportBlob">Export files (BLOBs)</a></li>
</ul>




<a name="Harvest"></a><section id="Harvest">
<h3><a name="Extract_PDS4_Product_Metadata"></a>Extract PDS4 Product Metadata</h3>

<p>
Run Harvest tool to crawl PDS4 products and extract metadata in JSON (NJSON) format.
In addition to some basic information, such as lid, vid, product class, internal references, 
file name and size, you can configure additional fields to export.
Optionally the whole PDS product labels can be stored as BLOBs (Binary Large OBjects).
</p>


<p>
After running Harvest, the output folder (default is /tmp/harvest/out/) will have several files
</p>
<ul>

<li><i>registry-docs.json</i> - metadata extracted from PDS4 labels, stored in Newline-delimited JSON (NJSON) format.</li>

<li><i>refs-docs.json</i> - product references extracted from collection inventory files.</li>

<li><i>fields.txt</i> - a list of field names extracted from PDS4 labels.</li>

<li><i>supplemental.txt</i> - a list of supplemental products (file paths).</li>
</ul>



<p>
See <a href="harvest.html">Harvest Documentation</a> for more information.
</p>
</section>



<a name="CRUD"></a><section id="CRUD">
<h3><a name="Create.2C_Delete.2C_Customize_Registry"></a>Create, Delete, Customize Registry</h3>

<p>
You must create following registry indices in Elasticsearch, before loading data generated by Harvest tool.
</p>

<ul>

<li><b>registry</b> - this index stores metadata extracted from PDS4 labels, one ES document per PDS label.</li>

<li><b>registry-dd</b> - this index stores data dictionary - a list of searchable fields and its data types.
When registry is created, the data dictionary is populated with fields (attributes) from PDS common and few discipline dictionaries.
You can add more fields as described in <a href="reg-custom.html#DD">Registry Customization / Data Dictionary</a> section.</li>

<li><b>registry-refs</b> - this index stores product references extracted from collection inventory files.
There could be 1 or more ES documents per inventory file.</li>
</ul>

<section>
<h4><a name="Create_Registry"></a>Create Registry</h4>


<p>
To create registry indices in local Elasticsearch (running at <i>http://localhost:9200</i>) 
with 1 shard and 0 replicas, run the following Registry Manager command
</p>

<div class="source"><pre class="prettyprint">
registry-manager create-registry
</pre></div>


<p>
You can customize <i>create-registry</i> command by passing several parameters, 
such as Elasticsearch URL, number of shards and replicas, authentication parameters.
To see the list of available parameters and basic usage run
</p>
<div class="source"><pre class="prettyprint">
registry-manager create-registry -help
</pre></div>



<p>
To check that registry indices were created open the following URL in 
a browser: <i>http://localhost:9200/_cat/indices?v</i> or use <i>curl</i>.
</p>

<div class="source"><pre class="prettyprint">
curl &quot;http://localhost:9200/_cat/indices?v&quot;
</pre></div>


<p>
The response should look similar to this. Make sure that index status is &quot;green&quot;. 
</p>

<div class="source"><pre class="prettyprint">
health status index         uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   registry      PY6ObzELRlSx9gHOWbR8dw   1   0          0            0       208b           208b
green  open   registry-dd   CuJ-nqg1SbKI9hejHrISWA   1   0       2505            0      625kb          625kb
green  open   registry-refs 1cJLc-9cQj2D_MAYo7gOpw   1   0          0            0       208b           208b
</pre></div>



</section><section>
<h4><a name="Delete_Registry"></a>Delete Registry</h4>


<p>
To delete registry indices from local Elasticsearch run the following command:
</p>

<div class="source"><pre class="prettyprint">
registry-manager delete-registry
</pre></div>


<p>
You can customize <i>delete-registry</i> command by passing several parameters, 
such as Elasticsearch URL, and authentication parameters.
</p>



</section><section>
<h4><a name="Registry_Customization"></a>Registry Customization</h4>

<p>
The main customization you would need to do is to update registry data dictionary of searchable fields and its datatypes.
More information about registry customization is available <a href="reg-custom.html">here</a>.
</p>
</section></section>



<a name="Load"></a><section id="Load">
<h3><a name="Load_Metadata"></a>Load Metadata</h3>

<p>
JSON files generated by Harvest, can be loaded into Elasticsearch 
by <a href="reg-manager.html">Registry Manager</a> as shown below. 
</p>

<div class="source"><pre class="prettyprint">
registry-manager load-data -dir /home/pds/harvest/out/
</pre></div>

<section>
<h4><a name="Automatic_Schema_Update_and_Common_Errors"></a>Automatic Schema Update and Common Errors</h4>

<p>
By default, registry manager will try updating registry schema (add more fields)
from <i>fields.txt</i> file (generated by Harvest) located in the same directory as <i>es-docs.json</i>.
</p>

<p>
You might see following error if you decide to copy <i>es-docs.json</i> file from Harvest output folder to another location
and forget to copy <i>fields.txt</i>.
</p>

<div class="source"><pre class="prettyprint">
[ERROR] /my-folder/fields.txt (The system cannot find the file specified)
</pre></div>


<p>
When registry is created, the registry data dictionary is populated with field definitions (field name to data type mappings) 
from PDS common and few discipline dictionaries. If you try loading labels with fields not defined in the registry data dictionary,
you will get the following error:
</p>

<div class="source"><pre class="prettyprint">
[ERROR] Could not find datatype for field '...'
</pre></div>

<p>
You have to update the registry data dictionary as described in <a href="reg-custom.html">Registry Customization</a> section
before you can load the data.
</p>

<p>
If you have non-standard registry configuration and know what you are doing, 
you can disable schema update by passing <i>updateSchema</i> parameter to <i>load-data</i> command.
</p>

<div class="source"><pre class="prettyprint">
registry-manager load-data -dir /home/pds/harvest/out/ -updateSchema n
</pre></div>

</section><section>
<h4><a name="Accidental_Update_of_Existing_Documents"></a>Accidental Update of Existing Documents</h4>

<p>
Registry index uses lidvid as a primary key. 
If you load data with the same lidvids multiple times, old documents will be replaced by new documents.
We plan to implement additional check to prevent accidental update of existing documents in next release.
</p>

</section></section>



<a name="View"></a><section id="View">
<h3><a name="View_.2F_Search_Metadata"></a>View / Search Metadata</h3>

<section>
<h4><a name="Elasticsearch_Search_API"></a>Elasticsearch Search API</h4>


<p>
You can either use simple Lucene queries, passed in the URL:
</p>

<div class="source"><pre class="prettyprint">
curl &quot;http://localhost:9200/registry/_search?q=product_class:Product_Collection&amp;pretty&quot;
</pre></div>


<p>
Or more advanced Elasticsearch queries defined in JSON and passed in request body:
</p>


<div class="source"><pre class="prettyprint">
curl -X GET &quot;localhost:9200/registry/_search?pretty&quot; -H 'Content-Type: application/json' -d'
{
  &quot;query&quot;: {
    &quot;term&quot;: {
      &quot;product_class&quot;: &quot;Product_Collection&quot;
    }
  }
}
'
</pre></div>


<p>
You can find more about Elasticsearch Search API at 
<a class="externalLink" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.8/search-search.html" target="_blank">Elasticsearch web site</a>.
</p>

</section></section>



<a name="Delete"></a><section id="Delete">
<h3><a name="Delete_Metadata"></a>Delete Metadata</h3>

<p>
You can use <a href="reg-manager.html">Registry Manager</a> tool to delete metadata 
by lidvid, lid, package id (Harvest run id), or to delete all data. Few examples are shown below.
</p>
<div class="source"><pre class="prettyprint">
registry-manager delete-data -lidvid urn:nasa:pds:context:target:asteroid.4_vesta::1.1
registry-manager delete-data -lid urn:nasa:pds:context:target:asteroid.4_vesta
registry-manager delete-data -packageId 8d8ae96d-044e-473d-a278-62635b1c5977
registry-manager delete-data -all
</pre></div>



<p>
You can also use Elasticsearch 
<a class="externalLink" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.8/docs-delete-by-query.html" target="_blank">delete by query API</a>.
</p>
</section>



<a name="Export"></a><section id="Export">
<h3><a name="Export_Metadata"></a>Export Metadata</h3>

<p>
You can use <a href="reg-manager.html">Registry Manager</a> tool to export metadata 
by lidvid, package id (Harvest run id), or to export all data. Few examples are shown below.
</p>

<div class="source"><pre class="prettyprint">
registry-manager export-data -file /tmp/mydata.json -lidvid urn:nasa:pds:context:target:asteroid.4_vesta::1.1
registry-manager export-data -file /tmp/mydata.json -packageId 8d8ae96d-044e-473d-a278-62635b1c5977
registry-manager export-data -file /tmp/mydata.json -all
</pre></div>


<p>
Data is saved in a Newline Delimited JSON file which can be loaded into Elasticsearch by 'load-data' command. 
The same file format is used by Harvest and Elasticsearch 
<a class="externalLink" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.8/docs-bulk.html" target="_blank">bulk API</a>.
</p>

</section>



<a name="ExportBlob"></a><section id="ExportBlob">
<h3><a name="Export_Files_.28BLOBs.29"></a>Export Files (BLOBs)</h3>

<p>
If PDS product label BLOBs (Binary Large OBjects) were generated by Harvest, they can be exported 
by <a href="reg-manager.html">Registry Manager</a> tool as shown below.
</p>
<div class="source"><pre class="prettyprint">
registry-manager export-file -lidvid urn:nasa:pds:context:target:asteroid.4_vesta::1.1 -file /tmp/4_vesta.xml
</pre></div>


</section>

</section>



        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &#169;      2021<a href="https://pds.nasa.gov/">Planetary Data System</a>.
.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
